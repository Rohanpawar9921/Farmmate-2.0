{% extends 'base.html' %}
{% load static %}

{% block title %}My Profile - Farm-Mate{% endblock %}

{% block extra_css %}
<!-- Add Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<style>
  .profile-container {
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .profile-sidebar {
    border-right: 1px solid #eee;
  }
  
  .profile-nav .nav-link {
    color: #555;
    border-radius: 0;
    padding: 12px 20px;
    border-left: 4px solid transparent;
  }
  
  .profile-nav .nav-link:hover {
    background-color: rgba(46, 125, 50, 0.05);
  }
  
  .profile-nav .nav-link.active {
    background-color: rgba(46, 125, 50, 0.1);
    color: var(--primary);
    border-left: 4px solid var(--primary);
    font-weight: 600;
  }
  
  .profile-picture-container {
    width: 150px;
    height: 150px;
    margin: 0 auto 20px;
    position: relative;
  }
  
  .profile-picture {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
    border: 3px solid var(--primary);
  }
  
  .profile-picture-edit {
    position: absolute;
    right: 10px;
    bottom: 10px;
    background: var(--primary);
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    cursor: pointer;
  }
  
  .form-section {
    background-color: #f9f9f9;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
  }
  
  /* Image cropper styles */
  .img-container {
    max-height: 400px;
    width: 100%;
    margin-bottom: 1rem;
  }
  
  .preview-container {
    overflow: hidden;
    width: 150px;
    height: 150px;
    border-radius: 50%;
    margin: 0 auto;
    border: 3px solid var(--primary);
  }
  
  .hidden {
    display: none;
  }
  
  .selected-file-name {
    display: inline-block;
    padding: 0.5rem 0;
    font-weight: 500;
    color: #28a745;
  }
  
  #cropper-actions {
    margin-top: 1rem;
  }
  
  .tab-content {
    padding: 20px 0;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row profile-container">
    <!-- Sidebar -->
    <div class="col-md-3 profile-sidebar py-4">
      <div class="text-center mb-4">
        <div class="profile-picture-container">
          <img src="{{ profile_pic_url|default:user.profile.profile_picture.url }}" alt="Profile Picture" class="profile-picture">
          <a href="#profile-picture-tab" data-toggle="tab" class="profile-picture-edit" title="Change profile picture">
            <i class="fas fa-camera"></i>
          </a>
        </div>
        <h5 class="mb-1">{{ user.get_full_name|default:user.username }}</h5>
        <p class="text-muted mb-3">{{ user.profile.farmer_type|title }} Farmer</p>
      </div>
      
      <ul class="nav flex-column profile-nav">
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'dashboard' %}active{% endif %}" href="{% url 'dashboard' %}">
            <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'profile' %}active{% endif %}" href="{% url 'profile' %}">
            <i class="fas fa-user mr-2"></i> My Profile
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'croprecommendation' %}">
            <i class="fas fa-seedling mr-2"></i> Crop Recommendations
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'settings' %}active{% endif %}" href="{% url 'settings' %}">
            <i class="fas fa-cog mr-2"></i> Settings
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'logout' %}">
            <i class="fas fa-sign-out-alt mr-2"></i> Logout
          </a>
        </li>
      </ul>
    </div>
    
    <!-- Main Content -->
    <div class="col-md-9 py-4">
      <h2 class="mb-4">My Profile</h2>
      
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        {% endfor %}
      {% endif %}
      
      <!-- Tab navigation -->
      <ul class="nav nav-tabs" id="profile-tabs" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" id="profile-info-tab" data-toggle="tab" href="#profile-info" role="tab">
            <i class="fas fa-user mr-2"></i>Profile Information
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="profile-picture-tab" data-toggle="tab" href="#profile-picture" role="tab">
            <i class="fas fa-camera mr-2"></i>Profile Picture
          </a>
        </li>
      </ul>
      
      <!-- Tab content -->
      <div class="tab-content" id="profile-tabs-content">
        <!-- Profile Info Tab -->
        <div class="tab-pane fade show active" id="profile-info" role="tabpanel">
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="profile_info">
            
            <div class="form-section">
              <h4 class="mb-3">Personal Information</h4>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="{{ user_form.username.id_for_label }}">Username</label>
                  <div class="form-group">
                    {{ user_form.username }}
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="{{ user_form.email.id_for_label }}">Email</label>
                  <div class="form-group">
                    {{ user_form.email }}
                  </div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="{{ user_form.first_name.id_for_label }}">First Name</label>
                  <div class="form-group">
                    {{ user_form.first_name }}
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="{{ user_form.last_name.id_for_label }}">Last Name</label>
                  <div class="form-group">
                    {{ user_form.last_name }}
                  </div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="{{ profile_form.phone_number.id_for_label }}">Phone Number</label>
                  <div class="form-group">
                    {{ profile_form.phone_number }}
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="{{ profile_form.location.id_for_label }}">Location</label>
                  <div class="form-group">
                    {{ profile_form.location }}
                  </div>
                </div>
              </div>
              
              <div class="mb-3">
                <label for="{{ profile_form.bio.id_for_label }}">Bio</label>
                <div class="form-group">
                  {{ profile_form.bio }}
                </div>
                <small class="form-text text-muted">Tell us a little about yourself and your farming background.</small>
              </div>
            </div>
            
            <div class="form-section">
              <h4 class="mb-3">Farming Information</h4>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="{{ profile_form.farmer_type.id_for_label }}">Farmer Type</label>
                  <div class="form-group">
                    {{ profile_form.farmer_type }}
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="{{ profile_form.farming_experience.id_for_label }}">Farming Experience</label>
                  <div class="form-group">
                    {{ profile_form.farming_experience }}
                  </div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="{{ profile_form.farm_size.id_for_label }}">Farm Size (acres)</label>
                  <div class="form-group">
                    {{ profile_form.farm_size }}
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="{{ profile_form.preferred_crops.id_for_label }}">Preferred Crops</label>
                  <div class="form-group">
                    {{ profile_form.preferred_crops }}
                  </div>
                </div>
              </div>
            </div>
            
            <div class="text-center mt-4">
              <button type="submit" class="btn btn-primary btn-lg px-5">
                <i class="fas fa-save mr-2"></i>Save Profile Information
              </button>
            </div>
          </form>
        </div>
        
        <!-- Profile Picture Tab -->
        <div class="tab-pane fade" id="profile-picture" role="tabpanel">
          <div class="form-section">
            <h4 class="mb-3">Update Profile Picture</h4>
            <div class="row">
              <div class="col-md-4 text-center mb-4">
                <h6>Current Picture</h6>
                <img src="{{ profile_pic_url|default:user.profile.profile_picture.url }}" class="img-fluid rounded-circle" style="width: 150px; height: 150px; object-fit: cover;" alt="Current profile picture">
              </div>
              <div class="col-md-8">
                <form method="post" enctype="multipart/form-data" id="profile-pic-form">
                  {% csrf_token %}
                  <input type="hidden" name="form_type" value="profile_picture">
                  <input type="hidden" name="cropped_image" id="cropped-image-data">
                  
                  <div class="form-group">
                    <label for="profile-pic-input">Select New Profile Picture</label>
                    <div class="custom-file">
                      {{ profile_picture_form.profile_picture }}
                      <div class="mt-2 selected-file-name" id="selected-file-name">No file selected</div>
                    </div>
                    <small class="form-text text-muted">Upload a square image for best results. Maximum file size: 5MB.</small>
                  </div>
                  
                  <!-- Image Cropper Container (hidden initially) -->
                  <div id="cropper-container" class="hidden mt-4">
                    <h5>Crop Your Image</h5>
                    <div class="img-container">
                      <img id="cropper-image" src="" alt="Source Image">
                    </div>
                    
                    <div class="row" id="cropper-actions">
                      <div class="col-md-4 text-center">
                        <div class="preview-container">
                          <div id="image-preview"></div>
                        </div>
                        <label class="mt-2">Preview</label>
                      </div>
                      <div class="col-md-8 d-flex align-items-end">
                        <div class="btn-group">
                          <button type="button" class="btn btn-outline-secondary" id="rotate-left">
                            <i class="fas fa-undo"></i> Rotate Left
                          </button>
                          <button type="button" class="btn btn-outline-secondary" id="rotate-right">
                            <i class="fas fa-redo"></i> Rotate Right
                          </button>
                          <button type="button" class="btn btn-outline-secondary" id="zoom-in">
                            <i class="fas fa-search-plus"></i> Zoom In
                          </button>
                          <button type="button" class="btn btn-outline-secondary" id="zoom-out">
                            <i class="fas fa-search-minus"></i> Zoom Out
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="text-center mt-4">
                    <button type="button" class="btn btn-success btn-lg" id="save-crop-btn" disabled>
                      <i class="fas fa-crop mr-2"></i>Save Profile Picture
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Add Cropper.js Script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // DOM elements
    const imageInput = document.getElementById('profile-pic-input');
    const fileNameDisplay = document.getElementById('selected-file-name');
    const cropperContainer = document.getElementById('cropper-container');
    const cropperImage = document.getElementById('cropper-image');
    const imagePreview = document.getElementById('image-preview');
    const saveCropBtn = document.getElementById('save-crop-btn');
    const croppedImageData = document.getElementById('cropped-image-data');
    const profilePicForm = document.getElementById('profile-pic-form');
    
    // Initialize variables
    let cropper;
    
    // Check if URL has profile picture tab parameter
    if (window.location.hash === '#profile-picture') {
      document.querySelector('a[href="#profile-picture"]').click();
    }
    
    // Handle file selection
    imageInput.addEventListener('change', function(e) {
      const files = e.target.files;
      
      if (files && files.length > 0) {
        const file = files[0];
        
        // Display selected filename
        fileNameDisplay.textContent = file.name;
        fileNameDisplay.classList.add('text-success');
        
        // Check file type
        if (!file.type.match('image.*')) {
          alert('Please select an image file.');
          return;
        }
        
        // Check file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert('File size too large. Maximum 5MB allowed.');
          return;
        }
        
        // Create file reader to load image
        const reader = new FileReader();
        
        reader.onload = function(e) {
          // Set image source
          cropperImage.src = e.target.result;
          
          // Show cropper container
          cropperContainer.classList.remove('hidden');
          
          // Enable save button
          saveCropBtn.disabled = false;
          
          // Initialize cropper if it exists, destroy first
          if (cropper) {
            cropper.destroy();
          }
          
          // Create new cropper
          cropper = new Cropper(cropperImage, {
            aspectRatio: 1, // Square
            viewMode: 1, // Restrict crop box to not exceed the image
            preview: '#image-preview',
            guides: true,
            minContainerWidth: 300,
            minContainerHeight: 300,
            minCropBoxWidth: 100,
            minCropBoxHeight: 100,
            responsive: true,
            checkCrossOrigin: false,
          });
        };
        
        reader.readAsDataURL(file);
      }
    });
    
    // Cropper control buttons
    document.getElementById('rotate-left').addEventListener('click', function() {
      cropper.rotate(-90);
    });
    
    document.getElementById('rotate-right').addEventListener('click', function() {
      cropper.rotate(90);
    });
    
    document.getElementById('zoom-in').addEventListener('click', function() {
      cropper.zoom(0.1);
    });
    
    document.getElementById('zoom-out').addEventListener('click', function() {
      cropper.zoom(-0.1);
    });
    
    // Save cropped image
    saveCropBtn.addEventListener('click', function() {
      if (!cropper) return;
      
      try {
        // Get cropped canvas as data URL
        const canvasData = cropper.getCroppedCanvas({
          width: 300,
          height: 300,
          fillColor: '#fff',
          imageSmoothingEnabled: true,
          imageSmoothingQuality: 'high',
        }).toDataURL('image/jpeg');
        
        // Set cropped image data to hidden input
        croppedImageData.value = canvasData;
        
        // Submit the form
        profilePicForm.submit();
      } catch (error) {
        console.error('Error cropping image:', error);
        alert('There was an error processing your image. Please try again.');
      }
    });
  });
</script>
{% endblock %}